<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Simple Components - dynec</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="ch1-ecs.html"><strong aria-hidden="true">1.</strong> ECS</a></li><li class="chapter-item expanded "><a href="ch2-archetypes.html"><strong aria-hidden="true">2.</strong> Archetypes</a></li><li class="chapter-item expanded "><a href="ch3-components.html"><strong aria-hidden="true">3.</strong> Components</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch3.1-simple-components.html" class="active"><strong aria-hidden="true">3.1.</strong> Simple Components</a></li><li class="chapter-item expanded "><a href="ch3.2-isotope-components.html"><strong aria-hidden="true">3.2.</strong> Isotope Components</a></li></ol></li><li class="chapter-item expanded "><a href="ch4-systems.html"><strong aria-hidden="true">4.</strong> Systems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch4.1-states.html"><strong aria-hidden="true">4.1.</strong> Global and local states</a></li><li class="chapter-item expanded "><a href="ch4.2-component-access.html"><strong aria-hidden="true">4.2.</strong> Component access</a></li><li class="chapter-item expanded "><a href="ch4.3-partitions.html"><strong aria-hidden="true">4.3.</strong> Partitions</a></li><li class="chapter-item expanded "><a href="ch4.4-online-entity-updates.html"><strong aria-hidden="true">4.4.</strong> Online entity updates</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">dynec</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="simple-components"><a class="header" href="#simple-components">Simple components</a></h1>
<p>Simple components are components where
each entity can have at most one instance of the component.
A type can be used as a simple component for entities of archetype <code>A</code>
if it implements <a href="../dynec/comp/trait.Simple.html"><code>comp::Simple&lt;A&gt;</code></a>.
Dynec provides <a href="../dynec/attr.comp.html">a convenience macro</a> to do this:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[comp(of = Bullet)]
struct Location([f32; 3]);
<span class="boring">}
</span></code></pre></pre>
<p>This declares a simple component called <code>Location</code>
that can be used on <code>Bullet</code> entities.</p>
<p>The same type can be reused as components for multiple archetypes.
by applying the macro multiple times:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use dynec::comp;

#[comp(of = Player)]
#[comp(of = Bullet)]
struct Location([f32; 3]);
<span class="boring">}
</span></code></pre></pre>
<h2 id="initializer"><a class="header" href="#initializer">Initializer</a></h2>
<p>Simple components can be equipped with an auto-initializer.
If an entity is created without specifying this component,
the auto-initializer is called to fill the component.</p>
<p>The auto-initializer can read values of other simple components,
either specified by the entity creator or returned by another auto-initializer.
Since Dynec does not persist a component
unless it is requested by a system or explicitly registered,
this means you can pass a temporary component during entity creation,
use its value in other component auto-initializers,
and this temporary component gets dropped after entity creation completes.</p>
<p>The auto-initializer can be specified in the macro
either as a closure:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use dynec::comp;

#[comp(of = Bullet, init = |velocity: &amp;Velocity| Damage(velocity.norm()))]
struct Damage(f32);
<span class="boring">}
</span></code></pre></pre>
<p>or as a function pointer with arity notation
(i.e. write the number of parameters for the function after a <code>/</code>):</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use dynec::comp;

fn default_damage(velocity: &amp;Velocity) -&gt; Damage {
    Damage(velocity.norm()) 
}

#[comp(of = Bullet, init = default_damage/1)]
struct Damage(f32);
<span class="boring">}
</span></code></pre></pre>
<h2 id="presence"><a class="header" href="#presence">Presence</a></h2>
<p>A component is either <code>Required</code> or <code>Optional</code>.</p>
<p><code>Optional</code> components may be missing on some entities.
Accessing optional components returns <code>Option&lt;C&gt;</code> instead of <code>C</code>.</p>
<p><code>Required</code> components must either have an auto-initializer
or be passed during entity creation.
This ensures that accessing the component always succeeds for an initialized entity;
optimizations such as chunk iteration are only possible for <code>Required</code> components.
Nevertheless, components are <strong>always</strong> missing
for uninitialized entities created during the middle of a tick;
more will be explained in later sections.</p>
<p>A <code>Required</code> component must <em>both</em>
set <a href="../dynec/comp/trait.SimpleOrIsotope.html#associatedconstant.PRESENCE"><code>PRESENCE = SimplePresence::Required</code></a>
<em>and</em> implement <a href="../dynec/comp/trait.Must.html"><code>comp::Must&lt;A&gt;</code></a>.
This is automatically done by specifying <code>required</code> in the <code>#[comp]</code> macro:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use dynec::comp;

#[comp(of = Bullet, required)]
struct Damage(u32);
<span class="boring">}
</span></code></pre></pre>
<h2 id="finalizers"><a class="header" href="#finalizers">Finalizers</a></h2>
<p>A finalizer component is a component that prevents an entity from getting deleted.</p>
<blockquote>
<p>Yes, I know this may be confusing.
Contrary to finalizers in Java/C#,
a finalizer is a data component instead of a function.
They are actually more similar to <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/">finalizers in Kubernetes</a>.</p>
</blockquote>
<p>When an entity is flagged for deletion,
Dynec checks if all finalizer components for that entity have been removed.
If there is at least one present finalizer component for the entity,
the entity would instead be scheduled to asynchronously delete
when all finalizer components have been unset.</p>
<p>This gives systems a chance to execute cleanup logic
by reading the component data of the &quot;terminating&quot; entity.
For example, a system that despawns deleted bullets from network players
may get a chance to handle bullet deletion:</p>
<pre><code class="language-text">for each `Bullet` entity flagged for deletion:
    if `Despawn` componnent is set
        read component `NetworkId` for the entity
        broadcast despawn packet to all players
        unset the `Despawn` finalizer component
</code></pre>
<p>Without the finalizer component,
the system would be unable to get the <code>NetworkId</code> for the despawned bullet
since the component has been cleaned up.</p>
<div class="warning">
Deletion-flagged entities are checked every tick.
To avoid a growing backlog of entities to delete,
finalizer components should be removed as soon as possible
after deletion has been flagged.
</div>
<h2 id="best-practices"><a class="header" href="#best-practices">Best practices</a></h2>
<h3 id="small-component-structs"><a class="header" href="#small-component-structs">Small component structs</a></h3>
<p>Dynec prevents systems that write to the same component type
from executing concurrently to avoid data race.
In reality, most systems only need to access a subset of fields,
so avoid putting many unrelated fields in the same component type.
Instead, prefer small, often single-field structs,
unless the multiple fields are naturally related,
e.g. positions/RGB values that are always accessed together.</p>
<h3 id="optional-types"><a class="header" href="#optional-types">Optional types</a></h3>
<p>Avoid using <a href="https://doc.rust-lang.org/std/option/enum.Option.html"><code>Option</code></a> in component types;
instead, use optional components to represent unused fields.
By default, Dynec uses a compact bit vector to track the existence of components,
which only takes 1 bit per component.
Meanwhile, <code>Option&lt;T&gt;</code> needs to preserve the alignment of <code>T</code>,
so a type like <code>Option&lt;f64&gt;</code> is 128 bits large
(1 bit for <code>None</code>, 63 bits for alignment padding, 64 bits for the actual data),
which is very wasteful of memory.</p>
<h3 id="heap-allocated-types"><a class="header" href="#heap-allocated-types">Heap-allocated types</a></h3>
<p>Minimize external (heap) memory referenced in entity components.
Heap allocation/deallocation is costly,
and the memory allocated is randomly located in the memory,
which means the CPU needs to keep loading new memory pages
into its memory cache layers
and greatly worsens performance.
Dynec stores component data in (almost) contiguous memory
and prefers processing adjacent entities in the same CPU,
so keeping all relevant data in the component structure is preferred.</p>
<p>While this is inevitable for some component types like strings,
types like <code>Vec</code> can often be avoided:</p>
<ul>
<li>If each entity has a similar structure of items
(i.e. <code>comp[0]</code> for entity 1 has the same logic as <code>comp[0]</code> for entity 2),
use isotope components instead.</li>
<li>If the items in the vector are unstructured
(i.e. <code>comp[0]</code> for entity 1 has the same logic as <code>comp[1]</code> for entity 1),
consider turning each item into an entity and process the entity instead.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch3-components.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="ch3.2-isotope-components.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch3-components.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="ch3.2-isotope-components.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="mermaid.min.js"></script>
        <script type="text/javascript" src="mermaid-init.js"></script>
    </body>
</html>
